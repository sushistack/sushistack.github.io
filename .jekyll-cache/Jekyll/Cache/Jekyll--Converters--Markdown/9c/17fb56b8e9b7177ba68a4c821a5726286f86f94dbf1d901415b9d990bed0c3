I"@<p>웹 또는 앱 서비스에서 로그인을 구현하는 것은 간단하지 않은 일입니다. 로그인을 구현하기 위해서는 다양한 사전 지식들을 가지고 있어야합니다. 특히 세션이나 쿠키 등의 역할 등을 알아야하고, 보안적인 측면에서도 신경을 써주어야합니다.</p>

<p>하지만 로그인을 구현하기 위헤서 개발 시간을 단축시켜줄 수 있는 것이 있다면 어떨까요? 이번 글에서는 스프링부트에서 <code class="language-plaintext highlighter-rouge">Spring Security</code> 및 <code class="language-plaintext highlighter-rouge">OAuth2</code>를 포함한 여러가지 프레임워크와 라이브러리를 이용하여 REST API 기반의 소셜 로그인 기능을 구현하는 방법을 소개해리도록 하겠습니다.</p>

<h2 id="스프링부트-소셜-로그인">스프링부트 소셜 로그인</h2>

<p>스프링부트에서 구글, 페이스북, 네이버, 카카오 등 다양한 서비스를 이용하여 소셜 로그인을 구현할 수 있습니다.</p>

<blockquote>
  <ol>
    <li>스프링 보안 프레임워크 Spring Security 소개</li>
    <li>OAuth2.0 및 Spring OAuth 프레임워크 소개</li>
    <li>예제: 각 Provider에서 OAuth 로그인 서비스 등록</li>
    <li>예제: 스프링부트 OAuth 로그인 설정</li>
    <li>예제: 프론트엔드 및 백엔드 예제 프로젝트 연동 테스트</li>
  </ol>
</blockquote>

<p>위와 같은 순서로 Spring Security, OAuth2.0, Spring OAuth 프레임워크를 소개하고, 구글 로그인, 페이스북 로그인, 네이버 로그인, 카카오 로그인 등을 적용하는 예제 프로젝트를 만들어보도록 하겠습니다.</p>

<h3 id="oauth-로그인을-위한-spring-하위-프레임워크">OAuth 로그인을 위한 Spring 하위 프레임워크</h3>

<p>스프링부트로 생성된 프로젝트에서 OAuth 로그인을 구현하기 위해서는 일반적으로 스프링 시큐리티와 스프링 시큐리티 OAuth2 클라이언트를 이용합니다.</p>

<h4 id="spring-security">Spring Security</h4>

<div class="related-link-wrap">
    <a class="related-link" href="https://docs.spring.io/spring-security/site/docs/current/reference/html5" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
         <svg xmlns="http://www.w3.org/2000/svg" id="Layer_1" viewBox="0 0 767.8 768" width="2499" height="2500" style="&#10;    width: 24px;&#10;    height: 24px;&#10;    color: #8a4baf;&#10;"><style>.st0{fill:#8a4baf}</style><path class="st0" d="M698.3 40c-10.8 25.8-24.5 50.3-41 72.8C585.1 40.6 487.1 0 385 0 173.8 0 0 174 0 385.5 0 491 43.2 592 119.6 664.8l14.2 12.6c69.4 58.5 157.3 90.7 248 90.7 200.8 0 369.6-157.4 383.9-358 10.5-98.2-18.3-222.4-67.4-370.1zm-524 627c-6.2 7.7-15.7 12.2-25.6 12.2-18.1 0-32.9-14.9-32.9-33s14.9-33 32.9-33c7.5 0 14.9 2.6 20.7 7.4 14.1 11.4 16.3 32.3 4.9 46.4zm522.4-115.4c-95 126.7-297.9 84-428 90.1 0 0-23.1 1.4-46.3 5.2 0 0 8.7-3.7 20-8 91.3-31.8 134.5-38 190-66.5 104.5-53.2 207.8-169.6 229.3-290.7C621.9 398.2 501.3 498.3 391.4 539c-75.3 27.8-211.3 54.8-211.3 54.8l-5.5-2.9C82 545.8 79.2 345.1 247.5 280.3c73.7-28.4 144.2-12.8 223.8-31.8 85-20.2 183.3-84 223.3-167.2 44.8 133.1 98.7 341.5 2.1 470.3z" /></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">Spring Security Reference</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">docs.spring.io</span>
        </div>
      </div>
    </a>
</div>

<p><code class="language-plaintext highlighter-rouge">Spring Security</code>는 Spring 기반의 어플리케이션 권한과 인증, 인가 등의 보안을 담당하는 하위 프레임워크입니다. 스프링 시큐리티는 <strong>인증</strong>과 <strong>권한</strong>을 Filter 흐름에 따라 처리하게 구현되어 있고, 이미 대부분의 보안적인 로직들이 포함되어 있어 개발자가 추가로 개발하지 않아도 된다는 장점이 있습니다.</p>

<h4 id="oauth2란">OAuth2란?</h4>

<p>OAuth2란 Open Authentication2의 약자로 인증 및 권한획득을 위한 <strong>업계표준 프로토콜</strong>입니다.</p>

<p>OAuth2는 보안수준이 어느정도 검증된 플랫폼의 API를 이용하여 사용자 인증과 리소스에 대한 권한 획득(인가)을 할 수 있도록 해주는 역할을 하고, 대부분의 영향력이 있고 OAuth2 인증을 제공하는 플랫폼들은 모두 OAuth2 규칙을 지키는 API를 제공하고 있습니다.</p>

<p>그렇다면 왜 OAuth라는 프로토콜이 탄생하게 되었을까요? 그 이유는 보안수준이 검증되지 않은 플랫폼에 동일한 아이디와 패스워드를 사용하는 상황이 자주 발생했기 때문입니다. 여러 플랫폼에 회원 가입을 하게 되면 사용자는 일반적으로 동일한 아이디와 비밀번호를 사용하는 경우가 많기 때문에 보안에 취약해 질 수 밖에 없습니다.</p>

<p>반대로 OAuth 인증을 통하면 신뢰할 수 있는 플랫폼이 인증과 리소스에 대한 권한을 외부 플랫폼에 부여하므로써 위에서 언급했던 문제를 해결할 수 있고, 사용자는 회원가입을 한 번 더 하지 않아도되기 때문에 사용자 경험 측면에서도 장점이 있습니다.</p>

<h5 id="oauth20-구성-요소">OAuth2.0 구성 요소</h5>

<div class="hint-container info">
  <div class="hint-type info">
    <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" stroke="none" class="icon-7f6730be--text-3f89f380"><g><path d="M12.2 8.98c.06-.01.12-.03.18-.06.06-.02.12-.05.18-.09l.15-.12c.18-.19.29-.45.29-.71 0-.06-.01-.13-.02-.19a.603.603 0 0 0-.06-.19.757.757 0 0 0-.09-.18c-.03-.05-.08-.1-.12-.15-.28-.27-.72-.37-1.09-.21-.13.05-.23.12-.33.21-.04.05-.09.1-.12.15-.04.06-.07.12-.09.18-.03.06-.05.12-.06.19-.01.06-.02.13-.02.19 0 .26.11.52.29.71.1.09.2.16.33.21.12.05.25.08.38.08.06 0 .13-.01.2-.02M13 16v-4a1 1 0 1 0-2 0v4a1 1 0 1 0 2 0M12 3c-4.962 0-9 4.038-9 9 0 4.963 4.038 9 9 9 4.963 0 9-4.037 9-9 0-4.962-4.037-9-9-9m0 20C5.935 23 1 18.065 1 12S5.935 1 12 1c6.066 0 11 4.935 11 11s-4.934 11-11 11" fill-rule="evenodd"></path></g></svg>
  </div>
  <div class="hint-body-container">
    <div class="hint-body">
      
      <ol class="hint-list">
      
      
        <li>1. Resource Owner: 사용자</li>
      
        <li>2. Client: 리소스 서버에서 제공해주는 자원을 사용하는 외부 플랫폼</li>
      
        <li>3. Authorization Server: 외부 플랫폼이 리소스 서버의 사용자 자원을 사용하기 위한 인증 서버</li>
      
        <li>4. Resource Server: 사용자의 자원을 제공해주는 서버</li>
      
      </ol>
      
    </div>
  </div>
</div>

<p>OAuth2.0는 위와 같이 4개의 구성요소를 가지고 있습니다. 예를 들어 저는 페이스북 계정이 있고, 페이스북 로그인 기능을 지원하는 외부 플랫폼에 로그인 하려고합니다. 이런 경우 외부 플랫폼을 통해 페이스북 인증 서버(Authorization Server)에 인증 요청을 하게 되고 외부 플랫폼은 저의 페이스북 정보들(이름, 나이, 프로필 사진 등)을 사용할 수 있는 권한을 얻게 됩니다.</p>

<h5 id="oauth20-인증-종류">OAuth2.0 인증 종류</h5>

<div class="hint-container info">
  <div class="hint-type info">
    <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" stroke="none" class="icon-7f6730be--text-3f89f380"><g><path d="M12.2 8.98c.06-.01.12-.03.18-.06.06-.02.12-.05.18-.09l.15-.12c.18-.19.29-.45.29-.71 0-.06-.01-.13-.02-.19a.603.603 0 0 0-.06-.19.757.757 0 0 0-.09-.18c-.03-.05-.08-.1-.12-.15-.28-.27-.72-.37-1.09-.21-.13.05-.23.12-.33.21-.04.05-.09.1-.12.15-.04.06-.07.12-.09.18-.03.06-.05.12-.06.19-.01.06-.02.13-.02.19 0 .26.11.52.29.71.1.09.2.16.33.21.12.05.25.08.38.08.06 0 .13-.01.2-.02M13 16v-4a1 1 0 1 0-2 0v4a1 1 0 1 0 2 0M12 3c-4.962 0-9 4.038-9 9 0 4.963 4.038 9 9 9 4.963 0 9-4.037 9-9 0-4.962-4.037-9-9-9m0 20C5.935 23 1 18.065 1 12S5.935 1 12 1c6.066 0 11 4.935 11 11s-4.934 11-11 11" fill-rule="evenodd"></path></g></svg>
  </div>
  <div class="hint-body-container">
    <div class="hint-body">
      
      <ol class="hint-list">
      
      
        <li>1. Authorization Code Grant: 권한 코드 승인 방식</li>
      
        <li>2. Implicit Grant: 암시적 승인 방식</li>
      
        <li>3. Password Credentials Grant: 비밀번호 자격 증명 방식</li>
      
        <li>4. Client Credentials Grant: 클라이언트 자격 증명 방식</li>
      
      </ol>
      
    </div>
  </div>
</div>

<p>OAuth2.0에 명시된 인증 종류는 위와 같이 크게 4가지로 구분됩니다.</p>

<h6 id="authorization-code-grant">Authorization Code Grant</h6>

<p>일반적으로 서버 사이드에서 인증을 처리할 때 이용하는 방식으로 Resource Owner로부터 리소스 사용에 대한 허락을 의미하는 <code class="language-plaintext highlighter-rouge">Authorization Code</code>를 이용하여 Access Token을 요청하는 방식입니다. 이 방식은 Access Token이 바로 클라이언트로 전달되지 않기 때문에 다른 방식보다 보안에 좋은 특징을 가지고 있습니다.</p>

<h6 id="implicit-grant">Implicit Grant</h6>

<p>권한 코드 없이 바로 토큰을 발급하여 사용하는 방식으로 브라우저나 앱과 같은 서버와의 연동이 없는 어플리케이션에서 주로 사용됩니다. 권한 코드 검증이 들어가지 않기 때문에 보통 Read Only 서비스에서만 사용하는 것이 좋습니다.</p>

<h6 id="password-credentials-grant">Password Credentials Grant</h6>

<p>Client에 Service Provider(구글, 페이스북 등)의 아이디와 비밀번호를 저장해두고 사용하는 방식입니다. 일반적으로 Client와 Service Provider의 관계가 아주 긴밀한 관계일때만 사용하는 것이 좋습니다.</p>

<h6 id="client-credentials-grant">Client Credentials Grant</h6>

<p>Client와 Resource Owner가 같을 때 사용하는 인증 방식입니다. Client와 Resource Owner가 같기 때문에 추가적인 인증이 필요하지 않고 Authorization Server로부터 바로 토큰을 받을 수 있습니다.</p>

<h5 id="spring-oauth2-client">Spring OAuth2 Client</h5>

<p>일반적으로 OAuth 인증을 하기 위해서는 인증을 위한 여러가지 절차대로 진행해야만 인증이 가능합니다. 이러한 일련의 절차들을 설정 한번으로 간단하게 사용할 수 있도록 도와주는 것이 <code class="language-plaintext highlighter-rouge">Spring OAuth2 Client</code>입니다.</p>

<div class="hint-container success">
  <div class="hint-type success">
    <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M22 11.07V12a10 10 0 1 1-5.93-9.14"></path><polyline points="23 3 12 14 9 11"></polyline></g></svg>
  </div>
  <div class="hint-body-container">
    <div class="hint-body">
      
        <span class="hint-body-text">OAuth2 Client 또한 위에서 언급한대로 OAuth2.0 표준에 맞게 잘 설계가 되어 있습니다.</span>
      
    </div>
  </div>
</div>

<h2 id="spring-oauth-로그인-예제">Spring OAuth 로그인 예제</h2>

<p>프로젝트를 처음부터 만들면서 스프링에서 OAuth 로그인을 적용하는 방법을 소개해드리도록 하겠습니다.</p>

<h3 id="예제-작성에-참고한-프로젝트">예제 작성에 참고한 프로젝트</h3>

<div class="related-link-wrap">
    <a class="related-link" href="https://github.com/callicoder/spring-boot-react-oauth2-social-login-demo" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
         <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github-alt" class="svg-inline--fa fa-github-alt fa-w-15" role="img" viewBox="0 0 480 512" style="&#10;    width: 24px;&#10;    height: 24px;&#10;    color: #8a4baf;&#10;"><path fill="currentColor" d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z" /></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">Spring Boot React OAuth2 Social Login with Google, Facebook, and Github</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">github.com</span>
        </div>
      </div>
    </a>
</div>

<h3 id="필요한-프레임워크-또는-라이브러리">필요한 프레임워크 또는 라이브러리</h3>

<div class="hint-container info">
  <div class="hint-type info">
    <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" stroke="none" class="icon-7f6730be--text-3f89f380"><g><path d="M12.2 8.98c.06-.01.12-.03.18-.06.06-.02.12-.05.18-.09l.15-.12c.18-.19.29-.45.29-.71 0-.06-.01-.13-.02-.19a.603.603 0 0 0-.06-.19.757.757 0 0 0-.09-.18c-.03-.05-.08-.1-.12-.15-.28-.27-.72-.37-1.09-.21-.13.05-.23.12-.33.21-.04.05-.09.1-.12.15-.04.06-.07.12-.09.18-.03.06-.05.12-.06.19-.01.06-.02.13-.02.19 0 .26.11.52.29.71.1.09.2.16.33.21.12.05.25.08.38.08.06 0 .13-.01.2-.02M13 16v-4a1 1 0 1 0-2 0v4a1 1 0 1 0 2 0M12 3c-4.962 0-9 4.038-9 9 0 4.963 4.038 9 9 9 4.963 0 9-4.037 9-9 0-4.962-4.037-9-9-9m0 20C5.935 23 1 18.065 1 12S5.935 1 12 1c6.066 0 11 4.935 11 11s-4.934 11-11 11" fill-rule="evenodd"></path></g></svg>
  </div>
  <div class="hint-body-container">
    <div class="hint-body">
      
      <ol class="hint-list">
      
      
        <li>1. Spring Security</li>
      
        <li>2. OAuth2 Client</li>
      
        <li>3. Json Web Token(JWT)</li>
      
      </ol>
      
    </div>
  </div>
</div>

<div class="related-link-wrap">
    <a class="related-link" href="https://ko.wikipedia.org/wiki/JSON_%EC%9B%B9_%ED%86%A0%ED%81%B0" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
        
        <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" class="icon-7f6730be--text-3f89f380"><g><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></g></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">JSON 웹 토큰 - 위키백과, 우리 모두의 백과사전</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">ko.wikipedia.org</span>
        </div>
      </div>
    </a>
</div>

<p>Spring Security와 OAuth2 Client에 대해서는 간단하게 소개해드렸습니다. JWT에 대해서 궁금하시다면 상단 링크에서 자세하게 확인해보실 수 있습니다.</p>

<h3 id="서비스-등록">서비스 등록</h3>

<p>OAuth 로그인을 구현하기 위해서는 꼭 각 플랫폼에서 제공하는 OAuth 앱 또는 서비스를 등록해야합니다. 많이들 사용하는 구글, 페이스북, 네이버, 카카오 총 네 가지의 플랫폼에 서비스를 등록하는 방법을 소개해드리도록 하겠습니다.</p>

<p>각 플랫폼에서 서비스 등록하면 각 플랫폼별 <code class="language-plaintext highlighter-rouge">클라이언트ID</code>와 <code class="language-plaintext highlighter-rouge">클라이언트 secret</code>을 얻어야합니다.</p>

<h4 id="구글-oauth-서비스-등록">구글 OAuth 서비스 등록</h4>

<div class="related-link-wrap">
    <a class="related-link" href="https://console.cloud.google.com/apis" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
        
        <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" class="icon-7f6730be--text-3f89f380"><g><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></g></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">API 및 서비스 – API 및 서비스 – CommentAlert – Google Cloud Platform</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">console.cloud.google.com</span>
        </div>
      </div>
    </a>
</div>

<p>기본적으로 구글 계정은 있다는 가정하에 서비스 등록방법을 소개해보도록 하겠습니다. 구글 OAuth 서비스를 등록하기 위해서는 위 링크를 통해 콘솔로 접속해야합니다.</p>

<p><img src="/assets/images/google-oauth-registration01.jpg" alt="google oauth registration 01" /></p>

<p>콘솔 대시보드화면에서 프로젝트 만들기를 클릭하여 프로젝트를 생성화면으로 이동합니다.</p>

<p><img src="/assets/images/google-oauth-registration02.jpg" alt="google oauth registration 02" /></p>

<p>자신의 서비스에 대한 프로젝트 이름을 작성하고, 프로젝트를 생성합니다.</p>

<p><img src="/assets/images/google-oauth-registration03.jpg" alt="google oauth registration 03" /></p>

<p>구글 OAuth 클라이언트를 사용하기 위해서는 OAuth 동의화면이 먼저 구성되어 있어야합니다. 위 사진과 같이 <code class="language-plaintext highlighter-rouge">OAuth 동의 화면</code> 탭을 클릭하여 설정화면으로 이동합니다.</p>

<p><img src="/assets/images/google-oauth-registration04.jpg" alt="google oauth registration 04" /></p>

<p>앱 이름, 이메일, 로고(Optional)를 입력합니다.</p>

<p><img src="/assets/images/google-oauth-registration05.jpg" alt="google oauth registration 05" /></p>

<p>테스트용으로 만들 앱이라 <code class="language-plaintext highlighter-rouge">앱 도메인</code>은 입력하지 않고 넘어갑니다.</p>

<p><img src="/assets/images/google-oauth-registration06.jpg" alt="google oauth registration 06" /></p>

<p>역시 테스트용 앱이라서 승인된 도메인이 없으므로 도메인은 추가하지 않고, 개발자 연락처 정보만 입력해줍니다.</p>

<p><img src="/assets/images/google-oauth-registration07.jpg" alt="google oauth registration 07" /></p>

<p>범위(scope)는 사용할 데이터의 권한 범위를 의미합니다. 구글로부터 어떤 데이터에 접근하고 싶은지 선택할 수 있습니다.</p>

<p><img src="/assets/images/google-oauth-registration08.jpg" alt="google oauth registration 08" /></p>

<p>이메일 정보와 프로필정보만 필요하므로 위 사진과 같이 선택합니다.</p>

<p><img src="/assets/images/google-oauth-registration09.jpg" alt="google oauth registration 09" /></p>

<p>그 이외에는 건들지 않고 다음으로 넘어갑니다.</p>

<p><img src="/assets/images/google-oauth-registration10.jpg" alt="google oauth registration 10" /></p>

<p>테스트 사용자를 설정하는 화면입니다. 계정 주인 이외의 다른 테스터를 추가할 때 설정할 수 있습니다.</p>

<p><img src="/assets/images/google-oauth-registration11.jpg" alt="google oauth registration 11" /></p>

<p>OAuth 동의 화면 설정은 완료되었고, <code class="language-plaintext highlighter-rouge">사용자 인증 정보</code> 탭으로 이동합니다.</p>

<p><img src="/assets/images/google-oauth-registration12.jpg" alt="google oauth registration 12" /></p>

<p>상단의 사용자 인증정보 만들기를 클릭합니다.</p>

<p><img src="/assets/images/google-oauth-registration13.jpg" alt="google oauth registration 13" /></p>

<p>OAuth 클라이언트 ID를 선택합니다.</p>

<p><img src="/assets/images/google-oauth-registration14.jpg" alt="google oauth registration 14" /></p>

<p>클라이언트ID의 이름을 작성합니다.</p>

<p><img src="/assets/images/google-oauth-registration15.jpg" alt="google oauth registration 15" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/login/oauth2/code/google
</code></pre></div></div>

<p>리다이렉션 URI에 위와 같이 작성해줍니다. 이 URI는 밑에서 설명하겠지만 구글 로그인이 완료된 후 리다이렉션되는 페이지를 말합니다.</p>

<p><img src="/assets/images/google-oauth-registration16.jpg" alt="google oauth registration 16" /></p>

<p>OAuth 클라이언트를 생성하고 나면 클라이언트 ID(client-id)와 클라이언트 보안 비밀번호(client-secret)을 얻을 수 있습니다.</p>

<p>client-id와 client-secret은 스프링 OAuth 설정 시 사용되므로 잘 복사해두어야합니다.</p>

<h4 id="페이스북-oauth-서비스-등록">페이스북 OAuth 서비스 등록</h4>

<div class="related-link-wrap">
    <a class="related-link" href="https://developers.facebook.com" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
        
        <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" class="icon-7f6730be--text-3f89f380"><g><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></g></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">Facebook for Developers</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">developers.facebook.com</span>
        </div>
      </div>
    </a>
</div>

<p>역시나 페이스북 계정은 있다는 가정하에 서비스 등록방법을 소개해보도록 하겠습니다. 페이스북 로그인을 사용하기위해서는 위 링크를 통해 페이스북 개발자 페이지로 이동해야합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration01.jpg" alt="facebook oauth registration 01" /></p>

<p>오른쪽 상단에 내 앱이라는 탭을 선택하고, 앱 만들기를 클릭합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration02.jpg" alt="facebook oauth registration 02" /></p>

<p>앱 유형 선택은 <code class="language-plaintext highlighter-rouge">비즈니스</code>로 선택합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration03.jpg" alt="facebook oauth registration 03" /></p>

<p>자신의 서비스에 맞는 앱 이름을 설정해줍니다.</p>

<p><img src="/assets/images/facebook-oauth-registration04.jpg" alt="facebook oauth registration 04" /></p>

<p>앱 목적에는 클라이언트를 선택합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration05.jpg" alt="facebook oauth registration 05" /></p>

<p>앱이 생성되면 위 사진과 같이 앱ID가 생성된 것을 보실 수 있습니다. 그 이후 왼쪽 상단의 선택 박스를 클릭합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration06.jpg" alt="facebook oauth registration 06" /></p>

<p>저희는 테스트용으로 로그인을 할 것이기 때문에 <code class="language-plaintext highlighter-rouge">테스트 앱 만들기</code>를 선택합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration07.jpg" alt="facebook oauth registration 07" /></p>

<p>테스트 앱 이름을 적절하게 넣어주고 테스트 앱을 만듭니다.</p>

<p><img src="/assets/images/facebook-oauth-registration08.jpg" alt="facebook oauth registration 08" /></p>

<p>위 사진과 같이 테스트 앱이 만들어지면 앱ID가 새로 생성됩니다. 이 후 대시보드에서 Facebook 로그인의 설정 버튼을 클릭합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration09.jpg" alt="facebook oauth registration 09" /></p>

<p>Spring REST API로 OAuth 로그인을 구현할 것이기 때문에 웹 플랫폼을 선택합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration10.jpg" alt="facebook oauth registration 10" /></p>

<p>사이트 URL은 위 사진과 같이 <code class="language-plaintext highlighter-rouge">http://localhost:30000</code>으로 설정하고 저장합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration11.jpg" alt="facebook oauth registration 11" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/login/oauth2/code/google
</code></pre></div></div>

<p>왼쪽 탭 하단의 Facebook 설정으로 들어가서 리다이렉션 URL 설정하는 부분이 있습니다. 위 처럼 리다이렉션 URL을 설정해주고 저장합니다.</p>

<p><img src="/assets/images/facebook-oauth-registration12.jpg" alt="facebook oauth registration 12" /></p>

<p>기본 설정 탭으로 들어가면 앱ID(client-id)와 앱 시크릿 코드(client-secret)을 확인하실 수 있습니다.</p>

<p>앱ID와 앱 시크릿 코드를 복사해둡니다.</p>

<h4 id="네이버-oauth-서비스-등록">네이버 OAuth 서비스 등록</h4>

<div class="related-link-wrap">
    <a class="related-link" href="https://developers.naver.com" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
        
        <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" class="icon-7f6730be--text-3f89f380"><g><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></g></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">네이버 개발자 센터 - NAVER Developers</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">developers.naver.com</span>
        </div>
      </div>
    </a>
</div>

<p>역시나 네이버 계정을 이미 가지고 있다고 생각하고 서비스 등록 방법을 소개하겠습니다. 위 링크를 통해서 네이버 개발자 센터로 이동합니다.</p>

<p><img src="/assets/images/naver-oauth-registration01.jpg" alt="naver oauth registration 01" /></p>

<p>로그인을 한 후, 상단 탭의 내 어플리케이션을 선택합니다.</p>

<p><img src="/assets/images/naver-oauth-registration02.jpg" alt="naver oauth registration 02" /></p>

<p><code class="language-plaintext highlighter-rouge">Application 등록</code> 버튼을 클릭하여 새로운 어플리케이션을 등록합니다.</p>

<p><img src="/assets/images/naver-oauth-registration03.jpg" alt="naver oauth registration 03" /></p>

<p>어플리케이션의 이름을 설정합니다.</p>

<p><img src="/assets/images/naver-oauth-registration04.jpg" alt="naver oauth registration 04" /></p>

<p>사용할 API 중 네아로(네이버 아이디로 로그인) API를 선택하고, 위 사진과 같이 제공 정보(scope) 설정을 해줍니다.</p>

<p><img src="/assets/images/naver-oauth-registration05.jpg" alt="naver oauth registration 05" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>서비스 URL: http://localhost:3000
Callback URL: http://localhost:8080/login/ouath2/code/naver
</code></pre></div></div>

<p>환경은 PC 웹으로 선택하고 위 와 같이 서비스 URL과 Callback URL을 설정해줍니다.</p>

<p><img src="/assets/images/naver-oauth-registration06.jpg" alt="naver oauth registration 06" /></p>

<p>전부 설정이 완료되었으면 등록하기를 눌러 어플리케이션을 생성해줍니다.</p>

<p><img src="/assets/images/naver-oauth-registration07.jpg" alt="naver oauth registration 07" /></p>

<p>어플리케이션 생성이 완료되면 어플리케이션 정보를 확인할 수 있고, Client ID(client-id)와 Client Secret(client-secret)을 복사해둡니다.</p>

<h4 id="카카오-oauth-서비스-등록">카카오 OAuth 서비스 등록</h4>

<div class="related-link-wrap">
    <a class="related-link" href="https://developers.kakao.com" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
        
        <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" class="icon-7f6730be--text-3f89f380"><g><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></g></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">Kakao Developers</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">developers.kakao.com</span>
        </div>
      </div>
    </a>
</div>

<p>카카오 계정이 있다고 가정하고 서비스 등록 방법 소개하도록 하겠습니다. 위 링크를 통해서 카카오 개발자 페이지로 이동합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration01.jpg" alt="kakao oauth registration 01" /></p>

<p>로그인을 한 후, 상단 탬의 내 어플리케이션을 선택합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration02.jpg" alt="kakao oauth registration 02" /></p>

<p>위 사진과 같이 어플리케이션을 추가합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration03.jpg" alt="kakao oauth registration 03" /></p>

<p>어플리케이션 이름과 사업자명을 입력하고 저장합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration04.jpg" alt="kakao oauth registration 04" /></p>

<p>요약정보 화면을 보시면 앱키 리스트가 있는 것을 확인하실 수 있습니다. 저희는 REST API로 이용할 예정이기 때문에 <code class="language-plaintext highlighter-rouge">REST API 키</code>(client-id)를 복사해둡니다.</p>

<p>이 후, 왼쪽 탭의 동의 항목으로 이동합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration05.jpg" alt="kakao oauth registration 05" /></p>

<p>동의 항목 중 닉네임을 필수 동의로 한 후 저장합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration06.jpg" alt="kakao oauth registration 06" /></p>

<p>동의 항목 중 프로필 이미지 또한 필수 동의로 설정한 후 저장합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration07.jpg" alt="kakao oauth registration 07" /></p>

<p>이메일은 민감 정보로 분류가 될 수 있기 때문에 카카오의 승인을 받아야합니다. 따라서 선택 동의로 받도록 설정한 후 저장합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration08.jpg" alt="kakao oauth registration 08" /></p>

<p>위 사진과 같이 동의 항목(scope)을 설정합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration09.jpg" alt="kakao oauth registration 09" /></p>

<p>왼쪽 탭의 카카오 로그인을 선택한 후 활성화 설정을 <code class="language-plaintext highlighter-rouge">OFF</code> -&gt; <code class="language-plaintext highlighter-rouge">ON</code>으로 변경합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration10.jpg" alt="kakao oauth registration 10" /></p>

<p>다음은 Client Secret을 생성하기 위해 왼쪽에 보안 탭을 클릭하고 코드 생성 버튼을 눌러줍니다.</p>

<p><img src="/assets/images/kakao-oauth-registration11.jpg" alt="kakao oauth registration 11" /></p>

<p>코드값(client-secret)을 복사해둔 후, 활성화 상태를 사용으로 변경해줍니다.</p>

<p><img src="/assets/images/kakao-oauth-registration12.jpg" alt="kakao oauth registration 12" /></p>

<p>다음은 리다이렉션 URI 설정을 위해 다시 카카오 로그인 탭으로 이동하고, <code class="language-plaintext highlighter-rouge">Redirect URI 등록</code>을 클릭합니다.</p>

<p><img src="/assets/images/kakao-oauth-registration13.jpg" alt="kakao oauth registration 13" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/login/oauth2/code/kakao
</code></pre></div></div>

<p>위와 같이 리다이렉션 URI를 설정한 후, 저장해줍니다.</p>

<h3 id="전체-시퀀스-다이어그램">전체 시퀀스 다이어그램</h3>

<p><img src="/assets/images/springboot-oauth.jpg" alt="spring social diagram" /></p>

<div class="hint-container info">
  <div class="hint-type info">
    <svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" stroke="none" class="icon-7f6730be--text-3f89f380"><g><path d="M12.2 8.98c.06-.01.12-.03.18-.06.06-.02.12-.05.18-.09l.15-.12c.18-.19.29-.45.29-.71 0-.06-.01-.13-.02-.19a.603.603 0 0 0-.06-.19.757.757 0 0 0-.09-.18c-.03-.05-.08-.1-.12-.15-.28-.27-.72-.37-1.09-.21-.13.05-.23.12-.33.21-.04.05-.09.1-.12.15-.04.06-.07.12-.09.18-.03.06-.05.12-.06.19-.01.06-.02.13-.02.19 0 .26.11.52.29.71.1.09.2.16.33.21.12.05.25.08.38.08.06 0 .13-.01.2-.02M13 16v-4a1 1 0 1 0-2 0v4a1 1 0 1 0 2 0M12 3c-4.962 0-9 4.038-9 9 0 4.963 4.038 9 9 9 4.963 0 9-4.037 9-9 0-4.962-4.037-9-9-9m0 20C5.935 23 1 18.065 1 12S5.935 1 12 1c6.066 0 11 4.935 11 11s-4.934 11-11 11" fill-rule="evenodd"></path></g></svg>
  </div>
  <div class="hint-body-container">
    <div class="hint-body">
      
      <ol class="hint-list">
      
      
        <li>시퀀스 상단: OAuth2.0 표준을 따르는 소셜 로그인 시퀀스 다이어그램</li>
      
        <li>시퀀스 하단: JWT 토큰의 유효기간이 끝났을 때의 시퀀스 다이어그램</li>
      
      </ol>
      
    </div>
  </div>
</div>

<h4 id="시퀀스-설명">시퀀스 설명</h4>

<blockquote>
  <ol>
    <li>소셜 로그인 요청</li>
    <li>백엔드로 GET “/oauth2/authorization/{provider-id}?redirect_uri=http://localhost:3000/oauth/redirect”으로 OAuth 인가 요청</li>
    <li>Provider 별로 Authorization Code 인증을 할 수 있도록 리다이렉트 (Redirect: GET
“https://oauth.provider.com/oauth2.0/authorize?…”)</li>
    <li>리다이렉트 화면에서 provider 서비스에 로그인</li>
    <li>로그인이 완료된 후, Athorization server로부터 백엔드로 Authorization 코드 응답</li>
    <li>백엔드에서 인가 코드를 이용하여 Authorization Server에 엑세스 토큰 요청</li>
    <li>엑세스 토큰 획득</li>
    <li>엑세스 토큰을 이용하여 Resource Server에 유저 데이터 요청</li>
    <li>획득한 유저 데이터를 DB에 저장 후, JWT 엑세스 토큰과 리프레시 토큰을 생성</li>
    <li>리프레시 토큰은 수정 불가능한 쿠키에 저장하고, 엑세스 토큰은 프로트엔드 리다이렉트 URI 에 쿼리스트링에 토큰을 담아 리다이렉트 (Redirect: GET http://localhost:3000/oauth/redirect?token={jwt-token})</li>
    <li>프론트엔드에서 토큰을 저장 후, API 요청 시 헤더에 <code class="language-plaintext highlighter-rouge">Authroization: Bearer {token}</code>을 추가하여 요청</li>
    <li>백엔드에서는 토큰을 확인하여 권한 확인</li>
    <li>토큰이 만료된 경우, 쿠키에 저장된 리프레시 토큰을 이용하여 엑세스 토큰과 리프레시 토큰을 재발급</li>
  </ol>
</blockquote>

<h5 id="3번-요청-예시">3번 요청 예시</h5>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET
https://oauth.provider.com/oauth2.0/authorize
  ?response_type=code
  &amp;client_id={client_id}
  &amp;scope=profile
  &amp;state={random_string}
  &amp;redirect_uri=http://localhost:8080/login/oauth2/code/{provider-id}
</code></pre></div></div>

<h5 id="5번-리다이렉트-응답-예시">5번 리다이렉트 응답 예시</h5>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET
/login/oauth2/code/{provider-id}?code=MLiFGqZjfdubcXUqOexxdN4TKXCICuP1Kp9D5vKQcCwx5AmQPZewX5rDQAXE80ucXsSZZwo9c00AAAF68RgEXQ&amp;state=Vi2q6hfu7YqKwcVxrIaVt1FFzy-qkOMhVzbwf7CaEZU%3D
</code></pre></div></div>

<h5 id="6번-엑세스-토큰-요청-예시">6번 엑세스 토큰 요청 예시</h5>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST
https://auth.provider.com/oauth/token
{
  "grant_type": "authorization_code",
  "code": "MLiFGqZjfdubcXUqOexxdN4TKXCICuP1Kp9D5vKQcCwx5AmQPZewX5rDQAXE80ucXsSZZwo9c00AAAF68RgEXQ",
  "redirect_uri": "http://localhost:8080/login/oauth2/code/{provider-id}",
  "client_id": "{client-id}",
  "client_secret": "{client-secret}"
}
</code></pre></div></div>

<h5 id="8번-리소스-서버로-유저-정보-요청">8번 리소스 서버로 유저 정보 요청</h5>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET
https://api.provider.com/user/me
</code></pre></div></div>

<h3 id="예제-프로젝트">예제 프로젝트</h3>

<p>REST API 기반으로 OAuth 로그인을 구현하기 위해서는 프론트엔드와 백엔드 프로젝트 모두 있어야합니다. 따라서 다음과 같이 프론트엔드 프로젝트와 백엔드 프로젝트를 각각 생성하도록 하겠습니다.</p>

<p>이 포스팅에서는 주요 코드에 대한 설명만 할 예정이기 때문에 혹시 자세한 코드가 궁금하신 분이나 예제 프로젝트를 실행해보고 싶은 분들은 아래 링크를 통해 확인하시거나 실행해볼 수 있습니다.</p>

<h4 id="프론트엔드-vue-project">프론트엔드 (Vue Project)</h4>

<div class="related-link-wrap">
    <a class="related-link" href="https://github.com/sushistack/oauth-login-fe" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
         <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github-alt" class="svg-inline--fa fa-github-alt fa-w-15" role="img" viewBox="0 0 480 512" style="&#10;    width: 24px;&#10;    height: 24px;&#10;    color: #8a4baf;&#10;"><path fill="currentColor" d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z" /></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">sushistack/oauth-login-fe: OAuth login fe vue project</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">github.com</span>
        </div>
      </div>
    </a>
</div>

<h4 id="백엔드-spring-boot-project">백엔드 (Spring Boot Project)</h4>

<div class="related-link-wrap">
    <a class="related-link" href="https://github.com/sushistack/oauth-login-be" target="_blank" rel="nofollow noopener noreferrer">
      <div class="related-link-icon">
         <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github-alt" class="svg-inline--fa fa-github-alt fa-w-15" role="img" viewBox="0 0 480 512" style="&#10;    width: 24px;&#10;    height: 24px;&#10;    color: #8a4baf;&#10;"><path fill="currentColor" d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z" /></svg>
        
      </div>
      <div class="link-title-wrap">
        <div class="link-title">
          <div class="link-title-text">sushistack/oauth-login-be: OAuth login be spring boot project</div>
        </div>
      </div>
      <div class="display-link-wrap">
        <div class="display-link">
          <span class="display-link-text">github.com</span>
        </div>
      </div>
    </a>
</div>

<h3 id="프론트엔드-oauth-로그인">프론트엔드 OAuth 로그인</h3>

<p>프론트엔드의 경우, 소셜 로그인 버튼을 눌렀을 때, 백엔드에 어떤 요청을 하는지와 인증이 끝난 후, 엑세스 토큰을 어떻게 저장하는지에 대해서만 간략하게 알아보도록 하겠습니다.</p>

<h4 id="소셜-로그인-버튼">소셜 로그인 버튼</h4>

<p><img src="/assets/images/oauth-login.jpg" alt="oauth login" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/oauth2/authorization/{provider-id}?redirect_uri=http://localhost:3000/oauth/redirect
</code></pre></div></div>

<p>위 사진과 같이 각 서비스 제공자 별로 백엔드에 요청합니다.</p>

<p><code class="language-plaintext highlighter-rouge">redirect_uri</code>는 인증이 완료된 후, 백엔드 API에 접근할 수 있는 <strong>Access Token</strong>을 쿼리스트링으로 받을 수 있는 프론트엔드 페이지입니다.</p>

<h5 id="redirect-페이지">Redirect 페이지</h5>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">template</span> <span class="nx">lang</span><span class="o">=</span><span class="dl">"</span><span class="s2">pug</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/template</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mapMutations</span><span class="p">,</span> <span class="nx">mapActions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuex</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">created</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 컴포넌트 렌더링이 되었을 때,</span>

    <span class="c1">// 쿼리스트링으로부터 토큰을 획득</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$route</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">token</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span>

    <span class="c1">// 토큰이 존재하는 경우, Vuex Store에 토큰을 저장한다.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setToken</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fetchUser</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// 토큰이 있던 없던, 루트 페이지로 이동한다.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="dl">'</span><span class="s1">fetchUser</span><span class="dl">'</span><span class="p">]),</span>
    <span class="p">...</span><span class="nx">mapMutations</span><span class="p">([</span><span class="dl">'</span><span class="s1">setToken</span><span class="dl">'</span><span class="p">])</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 백엔드 --Redirect--&gt; 프론트엔드
http://localhost:3000/oauth/redirect?token={jwt-token}
</code></pre></div></div>

<p>소셜 로그인 요청에 파라미터로 같이 넣어주었던 <code class="language-plaintext highlighter-rouge">redirect_uri</code>에 쿼리스트링을 추가해 백엔드에서 프론트엔드로 토큰을 전달해준다.</p>

<p>프론트엔드에서 받은 토큰을 저장한 후, 백엔드 API 요청 시 헤더에 토큰을 추가하여 API를 사용할 수 있습니다.</p>

<h3 id="백엔드-oauth-로그인">백엔드 OAuth 로그인</h3>

<p>백엔드에 OAuth 설정은 코드량이 좀 많아 잘 설명드릴 수 있을지 걱정이 됩니다만 가능한 잘 설명드리도록 하겠습니다.</p>

<h4 id="buildgradle-의존성">build.gradle 의존성</h4>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//... 생략 ...</span>

<span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-data-jpa'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-oauth2-client'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-security'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-validation'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-log4j2'</span>
    <span class="n">implementation</span> <span class="s1">'io.jsonwebtoken:jjwt-api:0.11.2'</span>
    <span class="n">implementation</span> <span class="s1">'jakarta.xml.bind:jakarta.xml.bind-api:2.3.2'</span>
    <span class="n">runtimeOnly</span> <span class="s1">'io.jsonwebtoken:jjwt-impl:0.11.2'</span>
    <span class="n">runtimeOnly</span> <span class="s1">'io.jsonwebtoken:jjwt-jackson:0.11.2'</span>
    <span class="n">compileOnly</span> <span class="s1">'org.projectlombok:lombok'</span>
    <span class="n">developmentOnly</span> <span class="s1">'org.springframework.boot:spring-boot-devtools'</span>
    <span class="n">runtimeOnly</span> <span class="s1">'mysql:mysql-connector-java'</span>
    <span class="n">annotationProcessor</span> <span class="s1">'org.projectlombok:lombok'</span>
    <span class="n">testImplementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-test'</span>
    <span class="n">testImplementation</span> <span class="s1">'org.springframework.security:spring-security-test'</span>
<span class="o">}</span>

<span class="c1">//... 생략 ...</span>
</code></pre></div></div>

<h5 id="applicationyml">application.yml</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles.active</span><span class="pi">:</span> <span class="s">local</span>
  <span class="c1"># 데이터 소스 설정</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://localhost:3306/oauth_login_tutorial?useSSL=false&amp;serverTimezone=UTC&amp;useLegacyDatetimeCode=false&amp;allowPublicKeyRetrieval=true</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">hikari</span><span class="pi">:</span>
      <span class="na">pool-name</span><span class="pi">:</span> <span class="s">jpa-hikari-pool</span>
      <span class="na">maximum-pool-size</span><span class="pi">:</span> <span class="m">5</span>
      <span class="na">jdbc-url</span><span class="pi">:</span> <span class="s">${spring.datasource.url}</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">${spring.datasource.username}</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">${spring.datasource.password}</span>
      <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">${spring.datasource.driver-class-name}</span>
      <span class="na">data-source-properties</span><span class="pi">:</span>
        <span class="na">rewriteBatchedStatements</span><span class="pi">:</span> <span class="no">true</span>
  <span class="c1"># JPA 설정</span>
  <span class="na">jpa</span><span class="pi">:</span>
    <span class="na">generate-ddl</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">hibernate</span><span class="pi">:</span>
      <span class="na">ddl-auto</span><span class="pi">:</span> <span class="s">update</span>
    <span class="na">show-sql</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">properties</span><span class="pi">:</span>
      <span class="na">hibernate</span><span class="pi">:</span>
        <span class="na">dialect</span><span class="pi">:</span> <span class="s">org.hibernate.dialect.MySQL8Dialect</span>
        <span class="na">hbm2ddl.import_files_sql_extractor</span><span class="pi">:</span> <span class="s">org.hibernate.tool.hbm2ddl.MultipleLinesSqlCommandExtractor</span>
        <span class="na">current_session_context_class</span><span class="pi">:</span> <span class="s">org.springframework.orm.hibernate5.SpringSessionContext</span>
        <span class="na">default_batch_fetch_size</span><span class="pi">:</span> <span class="s">${chunkSize:100}</span>
        <span class="na">jdbc.batch_size</span><span class="pi">:</span> <span class="m">20</span>
        <span class="na">order_inserts</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">order_updates</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">format_sql</span><span class="pi">:</span> <span class="no">true</span>
  <span class="c1"># Security OAuth</span>
  <span class="na">security</span><span class="pi">:</span>
    <span class="na">oauth2.client</span><span class="pi">:</span>
      <span class="na">registration</span><span class="pi">:</span>
        <span class="na">google</span><span class="pi">:</span>
          <span class="na">clientId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{구글</span><span class="nv"> </span><span class="s">client-id}'</span>
          <span class="na">clientSecret</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{구글</span><span class="nv"> </span><span class="s">client-secret}'</span>
          <span class="na">scope</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">email</span>
            <span class="pi">-</span> <span class="s">profile</span>
        <span class="na">facebook</span><span class="pi">:</span>
          <span class="na">clientId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{페이스북</span><span class="nv"> </span><span class="s">client-id}'</span>
          <span class="na">clientSecret</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{페이스북</span><span class="nv"> </span><span class="s">client-secret}'</span>
          <span class="na">scope</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">email</span>
            <span class="pi">-</span> <span class="s">public_profile</span>
        <span class="na">naver</span><span class="pi">:</span>
          <span class="na">clientId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{네이버</span><span class="nv"> </span><span class="s">client-id}'</span>
          <span class="na">clientSecret</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{네이버</span><span class="nv"> </span><span class="s">client-secret}'</span>
          <span class="na">clientAuthenticationMethod</span><span class="pi">:</span> <span class="s">post</span>
          <span class="na">authorizationGrantType</span><span class="pi">:</span> <span class="s">authorization_code</span>
          <span class="na">redirectUri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{baseUrl}/{action}/oauth2/code/{registrationId}"</span>
          <span class="na">scope</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">nickname</span>
            <span class="pi">-</span> <span class="s">email</span>
            <span class="pi">-</span> <span class="s">profile_image</span>
          <span class="na">clientName</span><span class="pi">:</span> <span class="s">Naver</span>
        <span class="na">kakao</span><span class="pi">:</span>
          <span class="na">clientId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{카카오</span><span class="nv"> </span><span class="s">client-id}'</span>
          <span class="na">clientSecret</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{카카오</span><span class="nv"> </span><span class="s">client-secret}'</span>
          <span class="na">clientAuthenticationMethod</span><span class="pi">:</span> <span class="s">post</span>
          <span class="na">authorizationGrantType</span><span class="pi">:</span> <span class="s">authorization_code</span>
          <span class="na">redirectUri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{baseUrl}/{action}/oauth2/code/{registrationId}"</span>
          <span class="na">scope</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">profile_nickname</span>
            <span class="pi">-</span> <span class="s">profile_image</span>
            <span class="pi">-</span> <span class="s">account_email</span>
          <span class="na">clientName</span><span class="pi">:</span> <span class="s">Kakao</span>
      <span class="c1"># Provider 설정</span>
      <span class="na">provider</span><span class="pi">:</span>
        <span class="na">naver</span><span class="pi">:</span>
          <span class="na">authorizationUri</span><span class="pi">:</span> <span class="s">https://nid.naver.com/oauth2.0/authorize</span>
          <span class="na">tokenUri</span><span class="pi">:</span> <span class="s">https://nid.naver.com/oauth2.0/token</span>
          <span class="na">userInfoUri</span><span class="pi">:</span> <span class="s">https://openapi.naver.com/v1/nid/me</span>
          <span class="na">userNameAttribute</span><span class="pi">:</span> <span class="s">response</span>
        <span class="na">kakao</span><span class="pi">:</span>
          <span class="na">authorizationUri</span><span class="pi">:</span> <span class="s">https://kauth.kakao.com/oauth/authorize</span>
          <span class="na">tokenUri</span><span class="pi">:</span> <span class="s">https://kauth.kakao.com/oauth/token</span>
          <span class="na">userInfoUri</span><span class="pi">:</span> <span class="s">https://kapi.kakao.com/v2/user/me</span>
          <span class="na">userNameAttribute</span><span class="pi">:</span> <span class="s">id</span>

<span class="c1"># cors 설정</span>
<span class="na">cors</span><span class="pi">:</span>
  <span class="na">allowed-origins</span><span class="pi">:</span> <span class="s1">'</span><span class="s">http://localhost:3000'</span>
  <span class="na">allowed-methods</span><span class="pi">:</span> <span class="s">GET,POST,PUT,DELETE,OPTIONS</span>
  <span class="na">allowed-headers</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
  <span class="na">max-age</span><span class="pi">:</span> <span class="m">3600</span>

<span class="c1"># jwt secret key 설정</span>
<span class="na">jwt.secret</span><span class="pi">:</span> <span class="s1">'</span><span class="s">8sknjlO3NPTBqo319DHLNqsQAfRJEdKsETOds'</span>

<span class="c1"># 토큰 관련 secret Key 및 RedirectUri 설정</span>
<span class="na">app</span><span class="pi">:</span>
  <span class="na">auth</span><span class="pi">:</span>
    <span class="na">tokenSecret</span><span class="pi">:</span> <span class="s">926D96C90030DD58429D2751AC1BDBBC</span>
    <span class="na">tokenExpiry</span><span class="pi">:</span> <span class="m">1800000</span>
    <span class="na">refreshTokenExpiry</span><span class="pi">:</span> <span class="m">604800000</span>
  <span class="na">oauth2</span><span class="pi">:</span>
    <span class="na">authorizedRedirectUris</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">http://localhost:3000/oauth/redirect</span>
</code></pre></div></div>

<h4 id="프로젝트-구조">프로젝트 구조</h4>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>com/deeplify/tutorial/oauthlogin
├── OauthLoginApplication.java
├── api
│   ├── controller
│   │   ├── auth
│   │   │   └── AuthController.java
│   │   └── user
│   │       └── UserController.java
│   ├── entity
│   │   ├── auth
│   │   │   └── AuthReqModel.java
│   │   └── user
│   │       ├── User.java
│   │       └── UserRefreshToken.java
│   ├── repository
│   │   └── user
│   │       ├── UserRefreshTokenRepository.java
│   │       └── UserRepository.java
│   └── service
│       └── UserService.java
├── common
│   ├── ApiResponse.java
│   └── ApiResponseHeader.java
├── config
│   ├── properties
│   │   ├── AppProperties.java
│   │   └── CorsProperties.java
│   └── security
│       ├── JwtConfig.java
│       └── SecurityConfig.java
├── oauth
│   ├── entity
│   │   ├── ProviderType.java
│   │   ├── RoleType.java
│   │   └── UserPrincipal.java
│   ├── exception
│   │   ├── OAuthProviderMissMatchException.java
│   │   ├── RestAuthenticationEntryPoint.java
│   │   └── TokenValidFailedException.java
│   ├── filter
│   │   └── TokenAuthenticationFilter.java
│   ├── handler
│   │   ├── OAuth2AuthenticationFailureHandler.java
│   │   ├── OAuth2AuthenticationSuccessHandler.java
│   │   └── TokenAccessDeniedHandler.java
│   ├── info
│   │   ├── OAuth2UserInfo.java
│   │   ├── OAuth2UserInfoFactory.java
│   │   └── impl
│   │       ├── FacebookOAuth2UserInfo.java
│   │       ├── GoogleOAuth2UserInfo.java
│   │       ├── KakaoOAuth2UserInfo.java
│   │       └── NaverOAuth2UserInfo.java
│   ├── repository
│   │   └── OAuth2AuthorizationRequestBasedOnCookieRepository.java
│   ├── service
│   │   ├── CustomOAuth2UserService.java
│   │   └── CustomUserDetailsService.java
│   └── token
│       ├── AuthToken.java
│       └── AuthTokenProvider.java
└── utils
    ├── CookieUtil.java
    └── HeaderUtil.java
</code></pre></div></div>

<p>전체 프로젝트 구조입니다. 이렇게 보니까 양이 엄청 많아보이지만 OAuth 로그인 설정에 꼭 필요합니다.</p>

<p>지금부터 하나하나 살펴보도록 하겠습니다.</p>

<h5 id="authtoken">AuthToken</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthToken</span> <span class="o">{</span>

    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">token</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AUTHORITIES_KEY</span> <span class="o">=</span> <span class="s">"role"</span><span class="o">;</span>

    <span class="nc">AuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">expiry</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">createAuthToken</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">expiry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">AuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">role</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">expiry</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">createAuthToken</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">role</span><span class="o">,</span> <span class="n">expiry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">createAuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">expiry</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="n">expiry</span><span class="o">)</span>
                <span class="o">.</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">createAuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">role</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">expiry</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">claim</span><span class="o">(</span><span class="no">AUTHORITIES_KEY</span><span class="o">,</span> <span class="n">role</span><span class="o">)</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="n">expiry</span><span class="o">)</span>
                <span class="o">.</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getTokenClaims</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Claims</span> <span class="nf">getTokenClaims</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">parserBuilder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SecurityException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Invalid JWT signature."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MalformedJwtException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Invalid JWT token."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExpiredJwtException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Expired JWT token."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedJwtException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Unsupported JWT token."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"JWT token compact of handler are invalid."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Claims</span> <span class="nf">getExpiredTokenClaims</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Jwts</span><span class="o">.</span><span class="na">parserBuilder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExpiredJwtException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Expired JWT token."</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">getClaims</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="authtokenprovider">AuthTokenProvider</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthTokenProvider</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AUTHORITIES_KEY</span> <span class="o">=</span> <span class="s">"role"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AuthTokenProvider</span><span class="o">(</span><span class="nc">String</span> <span class="n">secret</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="nc">Keys</span><span class="o">.</span><span class="na">hmacShaKeyFor</span><span class="o">(</span><span class="n">secret</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">AuthToken</span> <span class="nf">createAuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">expiry</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AuthToken</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">expiry</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">AuthToken</span> <span class="nf">createAuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">role</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">expiry</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AuthToken</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">role</span><span class="o">,</span> <span class="n">expiry</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">AuthToken</span> <span class="nf">convertAuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AuthToken</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">getAuthentication</span><span class="o">(</span><span class="nc">AuthToken</span> <span class="n">authToken</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span><span class="o">(</span><span class="n">authToken</span><span class="o">.</span><span class="na">validate</span><span class="o">())</span> <span class="o">{</span>

            <span class="nc">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">authToken</span><span class="o">.</span><span class="na">getTokenClaims</span><span class="o">();</span>
            <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span>
                    <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">AUTHORITIES_KEY</span><span class="o">).</span><span class="na">toString</span><span class="o">()})</span>
                            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">SimpleGrantedAuthority:</span><span class="o">:</span><span class="k">new</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"claims subject := [{}]"</span><span class="o">,</span> <span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">());</span>
            <span class="nc">User</span> <span class="n">principal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">(),</span> <span class="s">""</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">authToken</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">TokenValidFailedException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="jwtconfig">JwtConfig</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtConfig</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${jwt.secret}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">secret</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">AuthTokenProvider</span> <span class="nf">jwtProvider</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AuthTokenProvider</span><span class="o">(</span><span class="n">secret</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Jwt을 사용하기 위한 설정입니다.</p>

<h5 id="tokenauthenticationfilter">TokenAuthenticationFilter</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenAuthenticationFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AuthTokenProvider</span> <span class="n">tokenProvider</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span>
            <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
            <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>  <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">String</span> <span class="n">tokenStr</span> <span class="o">=</span> <span class="nc">HeaderUtil</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="nc">AuthToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">convertAuthToken</span><span class="o">(</span><span class="n">tokenStr</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">validate</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="tokenvalidfailedexception">TokenValidFailedException</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenValidFailedException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">TokenValidFailedException</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">"Failed to generate Token."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">TokenValidFailedException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="tokenaccessdeniedhandler">TokenAccessDeniedHandler</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenAccessDeniedHandler</span> <span class="kd">implements</span> <span class="nc">AccessDeniedHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HandlerExceptionResolver</span> <span class="n">handlerExceptionResolver</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AccessDeniedException</span> <span class="n">accessDeniedException</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//response.sendError(HttpServletResponse.SC_FORBIDDEN, accessDeniedException.getMessage());</span>
        <span class="n">handlerExceptionResolver</span><span class="o">.</span><span class="na">resolveException</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">accessDeniedException</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="providertype">ProviderType</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">ProviderType</span> <span class="o">{</span>
    <span class="no">GOOGLE</span><span class="o">,</span>
    <span class="no">FACEBOOK</span><span class="o">,</span>
    <span class="no">NAVER</span><span class="o">,</span>
    <span class="no">KAKAO</span><span class="o">,</span>
    <span class="no">LOCAL</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="roletype">RoleType</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">RoleType</span> <span class="o">{</span>
    <span class="no">USER</span><span class="o">(</span><span class="s">"ROLE_USER"</span><span class="o">,</span> <span class="s">"일반 사용자 권한"</span><span class="o">),</span>
    <span class="no">ADMIN</span><span class="o">(</span><span class="s">"ROLE_ADMIN"</span><span class="o">,</span> <span class="s">"관리자 권한"</span><span class="o">),</span>
    <span class="no">GUEST</span><span class="o">(</span><span class="s">"GUEST"</span><span class="o">,</span> <span class="s">"게스트 권한"</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">displayName</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">RoleType</span> <span class="nf">of</span><span class="o">(</span><span class="nc">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="nc">RoleType</span><span class="o">.</span><span class="na">values</span><span class="o">())</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">code</span><span class="o">))</span>
                <span class="o">.</span><span class="na">findAny</span><span class="o">()</span>
                <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="no">GUEST</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="user">User</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USER"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@JsonIgnore</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USER_SEQ"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">userSeq</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USER_ID"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">64</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">64</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USERNAME"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@JsonIgnore</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"PASSWORD"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">128</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">128</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"EMAIL"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">512</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">512</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"EMAIL_VERIFIED_YN"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">emailVerifiedYn</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"PROFILE_IMAGE_URL"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">512</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">512</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">profileImageUrl</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"PROVIDER_TYPE"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="nd">@Enumerated</span><span class="o">(</span><span class="nc">EnumType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="nc">ProviderType</span> <span class="n">providerType</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ROLE_TYPE"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="nd">@Enumerated</span><span class="o">(</span><span class="nc">EnumType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="nc">RoleType</span> <span class="n">roleType</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CREATED_AT"</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">createdAt</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"MODIFIED_AT"</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">modifiedAt</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span>
            <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">64</span><span class="o">)</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">512</span><span class="o">)</span> <span class="nc">String</span> <span class="n">email</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span> <span class="nc">String</span> <span class="n">emailVerifiedYn</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">512</span><span class="o">)</span> <span class="nc">String</span> <span class="n">profileImageUrl</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nc">ProviderType</span> <span class="n">providerType</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nc">RoleType</span> <span class="n">roleType</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nc">LocalDateTime</span> <span class="n">createdAt</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nc">LocalDateTime</span> <span class="n">modifiedAt</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="s">"NO_PASS"</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">email</span> <span class="o">:</span> <span class="s">"NO_EMAIL"</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">emailVerifiedYn</span> <span class="o">=</span> <span class="n">emailVerifiedYn</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">profileImageUrl</span> <span class="o">=</span> <span class="n">profileImageUrl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">profileImageUrl</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">providerType</span> <span class="o">=</span> <span class="n">providerType</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">roleType</span> <span class="o">=</span> <span class="n">roleType</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">modifiedAt</span> <span class="o">=</span> <span class="n">modifiedAt</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="userrepository">UserRepository</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="nf">findByUserId</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="userrefreshtoken">UserRefreshToken</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USER_REFRESH_TOKEN"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRefreshToken</span> <span class="o">{</span>
    <span class="nd">@JsonIgnore</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"REFRESH_TOKEN_SEQ"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">refreshTokenSeq</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USER_ID"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">64</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">64</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"REFRESH_TOKEN"</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">256</span><span class="o">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">refreshToken</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UserRefreshToken</span><span class="o">(</span>
            <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">64</span><span class="o">)</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">,</span>
            <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="o">)</span> <span class="nc">String</span> <span class="n">refreshToken</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">refreshToken</span> <span class="o">=</span> <span class="n">refreshToken</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="userrefreshtokenrepository">UserRefreshTokenRepository</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRefreshTokenRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">UserRefreshToken</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">UserRefreshToken</span> <span class="nf">findByUserId</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">);</span>
    <span class="nc">UserRefreshToken</span> <span class="nf">findByUserIdAndRefreshToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">refreshToken</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="userprincipal">UserPrincipal</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserPrincipal</span> <span class="kd">implements</span> <span class="nc">OAuth2User</span><span class="o">,</span> <span class="nc">UserDetails</span><span class="o">,</span> <span class="nc">OidcUser</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ProviderType</span> <span class="n">providerType</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RoleType</span> <span class="n">roleType</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">attributes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">authorities</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">getClaims</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">OidcUserInfo</span> <span class="nf">getUserInfo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">OidcIdToken</span> <span class="nf">getIdToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">UserPrincipal</span> <span class="nf">create</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UserPrincipal</span><span class="o">(</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getProviderType</span><span class="o">(),</span>
                <span class="nc">RoleType</span><span class="o">.</span><span class="na">USER</span><span class="o">,</span>
                <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="nc">RoleType</span><span class="o">.</span><span class="na">USER</span><span class="o">.</span><span class="na">getCode</span><span class="o">()))</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">UserPrincipal</span> <span class="nf">create</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">UserPrincipal</span> <span class="n">userPrincipal</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">userPrincipal</span><span class="o">.</span><span class="na">setAttributes</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">userPrincipal</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="customoauth2userservice">CustomOAuth2UserService</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomOAuth2UserService</span> <span class="kd">extends</span> <span class="nc">DefaultOAuth2UserService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">OAuth2User</span> <span class="nf">loadUser</span><span class="o">(</span><span class="nc">OAuth2UserRequest</span> <span class="n">userRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">OAuth2AuthenticationException</span> <span class="o">{</span>
        <span class="nc">OAuth2User</span> <span class="n">user</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">loadUser</span><span class="o">(</span><span class="n">userRequest</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">userRequest</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">AuthenticationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalAuthenticationServiceException</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">OAuth2User</span> <span class="nf">process</span><span class="o">(</span><span class="nc">OAuth2UserRequest</span> <span class="n">userRequest</span><span class="o">,</span> <span class="nc">OAuth2User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ProviderType</span> <span class="n">providerType</span> <span class="o">=</span> <span class="nc">ProviderType</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getRegistrationId</span><span class="o">().</span><span class="na">toUpperCase</span><span class="o">());</span>

        <span class="nc">OAuth2UserInfo</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="nc">OAuth2UserInfoFactory</span><span class="o">.</span><span class="na">getOAuth2UserInfo</span><span class="o">(</span><span class="n">providerType</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">());</span>
        <span class="nc">User</span> <span class="n">savedUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">savedUser</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">providerType</span> <span class="o">!=</span> <span class="n">savedUser</span><span class="o">.</span><span class="na">getProviderType</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">OAuthProviderMissMatchException</span><span class="o">(</span>
                        <span class="s">"Looks like you're signed up with "</span> <span class="o">+</span> <span class="n">providerType</span> <span class="o">+</span>
                        <span class="s">" account. Please use your "</span> <span class="o">+</span> <span class="n">savedUser</span><span class="o">.</span><span class="na">getProviderType</span><span class="o">()</span> <span class="o">+</span> <span class="s">" account to login."</span>
                <span class="o">);</span>
            <span class="o">}</span>
            <span class="n">updateUser</span><span class="o">(</span><span class="n">savedUser</span><span class="o">,</span> <span class="n">userInfo</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">savedUser</span> <span class="o">=</span> <span class="n">createUser</span><span class="o">(</span><span class="n">userInfo</span><span class="o">,</span> <span class="n">providerType</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nc">UserPrincipal</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">savedUser</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">User</span> <span class="nf">createUser</span><span class="o">(</span><span class="nc">OAuth2UserInfo</span> <span class="n">userInfo</span><span class="o">,</span> <span class="nc">ProviderType</span> <span class="n">providerType</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">LocalDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span>
                <span class="n">userInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span>
                <span class="n">userInfo</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                <span class="n">userInfo</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span>
                <span class="s">"Y"</span><span class="o">,</span>
                <span class="n">userInfo</span><span class="o">.</span><span class="na">getImageUrl</span><span class="o">(),</span>
                <span class="n">providerType</span><span class="o">,</span>
                <span class="nc">RoleType</span><span class="o">.</span><span class="na">USER</span><span class="o">,</span>
                <span class="n">now</span><span class="o">,</span>
                <span class="n">now</span>
        <span class="o">);</span>

        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">saveAndFlush</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">User</span> <span class="nf">updateUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">OAuth2UserInfo</span> <span class="n">userInfo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getImageUrl</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="na">getProfileImageUrl</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getImageUrl</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setProfileImageUrl</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getImageUrl</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="oauth2userinfofactory">OAuth2UserInfoFactory</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2UserInfoFactory</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">OAuth2UserInfo</span> <span class="nf">getOAuth2UserInfo</span><span class="o">(</span><span class="nc">ProviderType</span> <span class="n">providerType</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">providerType</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nl">GOOGLE:</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">GoogleOAuth2UserInfo</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
            <span class="k">case</span> <span class="nl">FACEBOOK:</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">FacebookOAuth2UserInfo</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
            <span class="k">case</span> <span class="nl">NAVER:</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">NaverOAuth2UserInfo</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
            <span class="k">case</span> <span class="nl">KAKAO:</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">KakaoOAuth2UserInfo</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
            <span class="k">default</span><span class="o">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"Invalid Provider Type."</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="oauth2userinfo">OAuth2UserInfo</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">OAuth2UserInfo</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OAuth2UserInfo</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">attributes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">getImageUrl</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="googleoauth2userinfo">GoogleOAuth2UserInfo</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoogleOAuth2UserInfo</span> <span class="kd">extends</span> <span class="nc">OAuth2UserInfo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">GoogleOAuth2UserInfo</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"sub"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getImageUrl</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"picture"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="facebookoauth2userinfo">FacebookOAuth2UserInfo</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FacebookOAuth2UserInfo</span> <span class="kd">extends</span> <span class="nc">OAuth2UserInfo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">FacebookOAuth2UserInfo</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getImageUrl</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"imageUrl"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="naveroauth2userinfo">NaverOAuth2UserInfo</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NaverOAuth2UserInfo</span> <span class="kd">extends</span> <span class="nc">OAuth2UserInfo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">NaverOAuth2UserInfo</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"response"</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"response"</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"nickname"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"response"</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getImageUrl</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"response"</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"profile_image"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="kakaooauth2userinfo">KakaoOAuth2UserInfo</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">KakaoOAuth2UserInfo</span> <span class="kd">extends</span> <span class="nc">OAuth2UserInfo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">KakaoOAuth2UserInfo</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">properties</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"properties"</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">properties</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">properties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"nickname"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"account_email"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getImageUrl</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">properties</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"properties"</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">properties</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">properties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"thumbnail_image"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="customuserdetailsservice">CustomUserDetailsService</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserDetailsService</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"Can not find username."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">UserPrincipal</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="oauth2authenticationfailurehandler">OAuth2AuthenticationFailureHandler</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2AuthenticationFailureHandler</span> <span class="kd">extends</span> <span class="nc">SimpleUrlAuthenticationFailureHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OAuth2AuthorizationRequestBasedOnCookieRepository</span> <span class="n">authorizationRequestRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">getCookie</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="no">REDIRECT_URI_PARAM_COOKIE_NAME</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cookie:</span><span class="o">:</span><span class="n">getValue</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElse</span><span class="o">((</span><span class="s">"/"</span><span class="o">));</span>

        <span class="n">exception</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>

        <span class="n">targetUrl</span> <span class="o">=</span> <span class="nc">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="n">targetUrl</span><span class="o">)</span>
                <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">exception</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">().</span><span class="na">toUriString</span><span class="o">();</span>

        <span class="n">authorizationRequestRepository</span><span class="o">.</span><span class="na">removeAuthorizationRequestCookies</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

        <span class="n">getRedirectStrategy</span><span class="o">().</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">targetUrl</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="oauth2authenticationsuccesshandler">OAuth2AuthenticationSuccessHandler</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2AuthenticationSuccessHandler</span> <span class="kd">extends</span> <span class="nc">SimpleUrlAuthenticationSuccessHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AuthTokenProvider</span> <span class="n">tokenProvider</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AppProperties</span> <span class="n">appProperties</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRefreshTokenRepository</span> <span class="n">userRefreshTokenRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OAuth2AuthorizationRequestBasedOnCookieRepository</span> <span class="n">authorizationRequestRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationSuccess</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="n">determineTargetUrl</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">authentication</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">isCommitted</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Response has already been committed. Unable to redirect to "</span> <span class="o">+</span> <span class="n">targetUrl</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">clearAuthenticationAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="n">getRedirectStrategy</span><span class="o">().</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">targetUrl</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">determineTargetUrl</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">redirectUri</span> <span class="o">=</span> <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">getCookie</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="no">REDIRECT_URI_PARAM_COOKIE_NAME</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cookie:</span><span class="o">:</span><span class="n">getValue</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">redirectUri</span><span class="o">.</span><span class="na">isPresent</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isAuthorizedRedirectUri</span><span class="o">(</span><span class="n">redirectUri</span><span class="o">.</span><span class="na">get</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Sorry! We've got an Unauthorized Redirect URI and can't proceed with the authentication"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="n">redirectUri</span><span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="n">getDefaultTargetUrl</span><span class="o">());</span>

        <span class="nc">OAuth2AuthenticationToken</span> <span class="n">authToken</span> <span class="o">=</span> <span class="o">(</span><span class="nc">OAuth2AuthenticationToken</span><span class="o">)</span> <span class="n">authentication</span><span class="o">;</span>
        <span class="nc">ProviderType</span> <span class="n">providerType</span> <span class="o">=</span> <span class="nc">ProviderType</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">authToken</span><span class="o">.</span><span class="na">getAuthorizedClientRegistrationId</span><span class="o">().</span><span class="na">toUpperCase</span><span class="o">());</span>

        <span class="nc">OidcUser</span> <span class="n">user</span> <span class="o">=</span> <span class="o">((</span><span class="nc">OidcUser</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">());</span>
        <span class="nc">OAuth2UserInfo</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="nc">OAuth2UserInfoFactory</span><span class="o">.</span><span class="na">getOAuth2UserInfo</span><span class="o">(</span><span class="n">providerType</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">());</span>
        <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="o">((</span><span class="nc">OidcUser</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">()).</span><span class="na">getAuthorities</span><span class="o">();</span>

        <span class="nc">RoleType</span> <span class="n">roleType</span> <span class="o">=</span> <span class="n">hasAuthority</span><span class="o">(</span><span class="n">authorities</span><span class="o">,</span> <span class="nc">RoleType</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">.</span><span class="na">getCode</span><span class="o">())</span> <span class="o">?</span> <span class="nc">RoleType</span><span class="o">.</span><span class="na">ADMIN</span> <span class="o">:</span> <span class="nc">RoleType</span><span class="o">.</span><span class="na">USER</span><span class="o">;</span>

        <span class="nc">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
        <span class="nc">AuthToken</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">createAuthToken</span><span class="o">(</span>
                <span class="n">userInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span>
                <span class="n">roleType</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getTokenExpiry</span><span class="o">())</span>
        <span class="o">);</span>

        <span class="c1">// refresh 토큰 설정</span>
        <span class="kt">long</span> <span class="n">refreshTokenExpiry</span> <span class="o">=</span> <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getRefreshTokenExpiry</span><span class="o">();</span>

        <span class="nc">AuthToken</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">createAuthToken</span><span class="o">(</span>
                <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getTokenSecret</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">refreshTokenExpiry</span><span class="o">)</span>
        <span class="o">);</span>

        <span class="c1">// DB 저장</span>
        <span class="nc">UserRefreshToken</span> <span class="n">userRefreshToken</span> <span class="o">=</span> <span class="n">userRefreshTokenRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userRefreshToken</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">userRefreshToken</span><span class="o">.</span><span class="na">setRefreshToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">userRefreshToken</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserRefreshToken</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">refreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
            <span class="n">userRefreshTokenRepository</span><span class="o">.</span><span class="na">saveAndFlush</span><span class="o">(</span><span class="n">userRefreshToken</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">cookieMaxAge</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">refreshTokenExpiry</span> <span class="o">/</span> <span class="mi">60</span><span class="o">;</span>

        <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">deleteCookie</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="no">REFRESH_TOKEN</span><span class="o">);</span>
        <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="no">REFRESH_TOKEN</span><span class="o">,</span> <span class="n">refreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">(),</span> <span class="n">cookieMaxAge</span><span class="o">);</span>

        <span class="k">return</span> <span class="nc">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="n">targetUrl</span><span class="o">)</span>
                <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"token"</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">().</span><span class="na">toUriString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">clearAuthenticationAttributes</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clearAuthenticationAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="n">authorizationRequestRepository</span><span class="o">.</span><span class="na">removeAuthorizationRequestCookies</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">hasAuthority</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">,</span> <span class="nc">String</span> <span class="n">authority</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authorities</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">GrantedAuthority</span> <span class="n">grantedAuthority</span> <span class="o">:</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">authority</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">grantedAuthority</span><span class="o">.</span><span class="na">getAuthority</span><span class="o">()))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isAuthorizedRedirectUri</span><span class="o">(</span><span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">URI</span> <span class="n">clientRedirectUri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">appProperties</span><span class="o">.</span><span class="na">getOauth2</span><span class="o">().</span><span class="na">getAuthorizedRedirectUris</span><span class="o">()</span>
                <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyMatch</span><span class="o">(</span><span class="n">authorizedRedirectUri</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="c1">// Only validate host and port. Let the clients use different paths if they want to</span>
                    <span class="no">URI</span> <span class="n">authorizedURI</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">authorizedRedirectUri</span><span class="o">);</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">authorizedURI</span><span class="o">.</span><span class="na">getHost</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">clientRedirectUri</span><span class="o">.</span><span class="na">getHost</span><span class="o">())</span>
                            <span class="o">&amp;&amp;</span> <span class="n">authorizedURI</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">==</span> <span class="n">clientRedirectUri</span><span class="o">.</span><span class="na">getPort</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="oauthprovidermissmatchexception">OAuthProviderMissMatchException</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthProviderMissMatchException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">OAuthProviderMissMatchException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="restauthenticationentrypoint">RestAuthenticationEntryPoint</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestAuthenticationEntryPoint</span> <span class="kd">implements</span> <span class="nc">AuthenticationEntryPoint</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commence</span><span class="o">(</span>
            <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
            <span class="nc">AuthenticationException</span> <span class="n">authException</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">authException</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Responding with unauthorized error. Message := {}"</span><span class="o">,</span> <span class="n">authException</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span>
                <span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_UNAUTHORIZED</span><span class="o">,</span>
                <span class="n">authException</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">()</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="appproperties">AppProperties</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"app"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppProperties</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Auth</span> <span class="n">auth</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Auth</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OAuth2</span> <span class="n">oauth2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OAuth2</span><span class="o">();</span>

    <span class="nd">@Getter</span>
    <span class="nd">@Setter</span>
    <span class="nd">@NoArgsConstructor</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Auth</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">tokenSecret</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">tokenExpiry</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">refreshTokenExpiry</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OAuth2</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">authorizedRedirectUris</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getAuthorizedRedirectUris</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">authorizedRedirectUris</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">OAuth2</span> <span class="nf">authorizedRedirectUris</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">authorizedRedirectUris</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">authorizedRedirectUris</span> <span class="o">=</span> <span class="n">authorizedRedirectUris</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="corsproperties">CorsProperties</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"cors"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CorsProperties</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">allowedOrigins</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">allowedMethods</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">allowedHeaders</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">maxAge</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="securityconfig">SecurityConfig</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CorsProperties</span> <span class="n">corsProperties</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AppProperties</span> <span class="n">appProperties</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AuthTokenProvider</span> <span class="n">tokenProvider</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomUserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomOAuth2UserService</span> <span class="n">oAuth2UserService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenAccessDeniedHandler</span> <span class="n">tokenAccessDeniedHandler</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRefreshTokenRepository</span> <span class="n">userRefreshTokenRepository</span><span class="o">;</span>

    <span class="cm">/*
    * UserDetailsService 설정
    * */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">)</span>
                <span class="o">.</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
                    <span class="o">.</span><span class="na">cors</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">sessionManagement</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">formLogin</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">httpBasic</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="k">new</span> <span class="nc">RestAuthenticationEntryPoint</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">accessDeniedHandler</span><span class="o">(</span><span class="n">tokenAccessDeniedHandler</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nl">CorsUtils:</span><span class="o">:</span><span class="n">isPreFlightRequest</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/api/**"</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="nc">RoleType</span><span class="o">.</span><span class="na">USER</span><span class="o">.</span><span class="na">getCode</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/api/**/admin/**"</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="nc">RoleType</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">.</span><span class="na">getCode</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">oauth2Login</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">authorizationEndpoint</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">baseUri</span><span class="o">(</span><span class="s">"/oauth2/authorization"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">authorizationRequestRepository</span><span class="o">(</span><span class="n">oAuth2AuthorizationRequestBasedOnCookieRepository</span><span class="o">())</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">redirectionEndpoint</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">baseUri</span><span class="o">(</span><span class="s">"/*/oauth2/code/*"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">userInfoEndpoint</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">userService</span><span class="o">(</span><span class="n">oAuth2UserService</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">successHandler</span><span class="o">(</span><span class="n">oAuth2AuthenticationSuccessHandler</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">failureHandler</span><span class="o">(</span><span class="n">oAuth2AuthenticationFailureHandler</span><span class="o">());</span>

        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">tokenAuthenticationFilter</span><span class="o">(),</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/*
    * auth 매니저 설정
    * */</span>
    <span class="nd">@Override</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="nc">BeanIds</span><span class="o">.</span><span class="na">AUTHENTICATION_MANAGER</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">AuthenticationManager</span> <span class="nf">authenticationManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManager</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*
    * security 설정 시, 사용할 인코더 설정
    * */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">BCryptPasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*
    * 토큰 필터 설정
    * */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">TokenAuthenticationFilter</span> <span class="nf">tokenAuthenticationFilter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TokenAuthenticationFilter</span><span class="o">(</span><span class="n">tokenProvider</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/*
    * 쿠키 기반 인가 Repository
    * 인가 응답을 연계 하고 검증할 때 사용.
    * */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">OAuth2AuthorizationRequestBasedOnCookieRepository</span> <span class="nf">oAuth2AuthorizationRequestBasedOnCookieRepository</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OAuth2AuthorizationRequestBasedOnCookieRepository</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*
    * Oauth 인증 성공 핸들러
    * */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">OAuth2AuthenticationSuccessHandler</span> <span class="nf">oAuth2AuthenticationSuccessHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OAuth2AuthenticationSuccessHandler</span><span class="o">(</span>
                <span class="n">tokenProvider</span><span class="o">,</span>
                <span class="n">appProperties</span><span class="o">,</span>
                <span class="n">userRefreshTokenRepository</span><span class="o">,</span>
                <span class="n">oAuth2AuthorizationRequestBasedOnCookieRepository</span><span class="o">()</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/*
     * Oauth 인증 실패 핸들러
     * */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">OAuth2AuthenticationFailureHandler</span> <span class="nf">oAuth2AuthenticationFailureHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OAuth2AuthenticationFailureHandler</span><span class="o">(</span><span class="n">oAuth2AuthorizationRequestBasedOnCookieRepository</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/*
    * Cors 설정
    * */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">UrlBasedCorsConfigurationSource</span> <span class="nf">corsConfigurationSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">UrlBasedCorsConfigurationSource</span> <span class="n">corsConfigSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlBasedCorsConfigurationSource</span><span class="o">();</span>

        <span class="nc">CorsConfiguration</span> <span class="n">corsConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CorsConfiguration</span><span class="o">();</span>
        <span class="n">corsConfig</span><span class="o">.</span><span class="na">setAllowedHeaders</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">corsProperties</span><span class="o">.</span><span class="na">getAllowedHeaders</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">)));</span>
        <span class="n">corsConfig</span><span class="o">.</span><span class="na">setAllowedMethods</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">corsProperties</span><span class="o">.</span><span class="na">getAllowedMethods</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">)));</span>
        <span class="n">corsConfig</span><span class="o">.</span><span class="na">setAllowedOrigins</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">corsProperties</span><span class="o">.</span><span class="na">getAllowedOrigins</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">)));</span>
        <span class="n">corsConfig</span><span class="o">.</span><span class="na">setAllowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">corsConfig</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="n">corsConfig</span><span class="o">.</span><span class="na">getMaxAge</span><span class="o">());</span>

        <span class="n">corsConfigSource</span><span class="o">.</span><span class="na">registerCorsConfiguration</span><span class="o">(</span><span class="s">"/**"</span><span class="o">,</span> <span class="n">corsConfig</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">corsConfigSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="authreqmodel">AuthReqModel</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthReqModel</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="authcontroller">AuthController</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/v1/auth"</span><span class="o">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AppProperties</span> <span class="n">appProperties</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AuthTokenProvider</span> <span class="n">tokenProvider</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRefreshTokenRepository</span> <span class="n">userRefreshTokenRepository</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="no">THREE_DAYS_MSEC</span> <span class="o">=</span> <span class="mi">259200000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">REFRESH_TOKEN</span> <span class="o">=</span> <span class="s">"refresh_token"</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ApiResponse</span> <span class="nf">login</span><span class="o">(</span>
            <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
            <span class="nd">@RequestBody</span> <span class="nc">AuthReqModel</span> <span class="n">authReqModel</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">authenticationManager</span><span class="o">.</span><span class="na">authenticate</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span>
                        <span class="n">authReqModel</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span>
                        <span class="n">authReqModel</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()</span>
                <span class="o">)</span>
        <span class="o">);</span>

        <span class="nc">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">authReqModel</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
        <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>

        <span class="nc">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
        <span class="nc">AuthToken</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">createAuthToken</span><span class="o">(</span>
                <span class="n">userId</span><span class="o">,</span>
                <span class="o">((</span><span class="nc">UserPrincipal</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">()).</span><span class="na">getRoleType</span><span class="o">().</span><span class="na">getCode</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getTokenExpiry</span><span class="o">())</span>
        <span class="o">);</span>

        <span class="kt">long</span> <span class="n">refreshTokenExpiry</span> <span class="o">=</span> <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getRefreshTokenExpiry</span><span class="o">();</span>
        <span class="nc">AuthToken</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">createAuthToken</span><span class="o">(</span>
                <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getTokenSecret</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">refreshTokenExpiry</span><span class="o">)</span>
        <span class="o">);</span>

        <span class="c1">// userId refresh token 으로 DB 확인</span>
        <span class="nc">UserRefreshToken</span> <span class="n">userRefreshToken</span> <span class="o">=</span> <span class="n">userRefreshTokenRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userRefreshToken</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 없는 경우 새로 등록</span>
            <span class="n">userRefreshToken</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserRefreshToken</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">refreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
            <span class="n">userRefreshTokenRepository</span><span class="o">.</span><span class="na">saveAndFlush</span><span class="o">(</span><span class="n">userRefreshToken</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// DB에 refresh 토큰 업데이트</span>
            <span class="n">userRefreshToken</span><span class="o">.</span><span class="na">setRefreshToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">cookieMaxAge</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">refreshTokenExpiry</span> <span class="o">/</span> <span class="mi">60</span><span class="o">;</span>
        <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">deleteCookie</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="no">REFRESH_TOKEN</span><span class="o">);</span>
        <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="no">REFRESH_TOKEN</span><span class="o">,</span> <span class="n">refreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">(),</span> <span class="n">cookieMaxAge</span><span class="o">);</span>

        <span class="k">return</span> <span class="nc">ApiResponse</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">"token"</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/refresh"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ApiResponse</span> <span class="nf">refreshToken</span> <span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// access token 확인</span>
        <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="nc">HeaderUtil</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="nc">AuthToken</span> <span class="n">authToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">convertAuthToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">authToken</span><span class="o">.</span><span class="na">validate</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ApiResponse</span><span class="o">.</span><span class="na">invalidAccessToken</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// expired access token 인지 확인</span>
        <span class="nc">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">authToken</span><span class="o">.</span><span class="na">getExpiredTokenClaims</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">claims</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ApiResponse</span><span class="o">.</span><span class="na">notExpiredTokenYet</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="nc">RoleType</span> <span class="n">roleType</span> <span class="o">=</span> <span class="nc">RoleType</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"role"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>

        <span class="c1">// refresh token</span>
        <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">getCookie</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="no">REFRESH_TOKEN</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cookie:</span><span class="o">:</span><span class="n">getValue</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElse</span><span class="o">((</span><span class="kc">null</span><span class="o">));</span>
        <span class="nc">AuthToken</span> <span class="n">authRefreshToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">convertAuthToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authRefreshToken</span><span class="o">.</span><span class="na">validate</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ApiResponse</span><span class="o">.</span><span class="na">invalidRefreshToken</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// userId refresh token 으로 DB 확인</span>
        <span class="nc">UserRefreshToken</span> <span class="n">userRefreshToken</span> <span class="o">=</span> <span class="n">userRefreshTokenRepository</span><span class="o">.</span><span class="na">findByUserIdAndRefreshToken</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">refreshToken</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userRefreshToken</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ApiResponse</span><span class="o">.</span><span class="na">invalidRefreshToken</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
        <span class="nc">AuthToken</span> <span class="n">newAccessToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">createAuthToken</span><span class="o">(</span>
                <span class="n">userId</span><span class="o">,</span>
                <span class="n">roleType</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getTokenExpiry</span><span class="o">())</span>
        <span class="o">);</span>

        <span class="kt">long</span> <span class="n">validTime</span> <span class="o">=</span> <span class="n">authRefreshToken</span><span class="o">.</span><span class="na">getTokenClaims</span><span class="o">().</span><span class="na">getExpiration</span><span class="o">().</span><span class="na">getTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>

        <span class="c1">// refresh 토큰 기간이 3일 이하로 남은 경우, refresh 토큰 갱신</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">validTime</span> <span class="o">&lt;=</span> <span class="no">THREE_DAYS_MSEC</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// refresh 토큰 설정</span>
            <span class="kt">long</span> <span class="n">refreshTokenExpiry</span> <span class="o">=</span> <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getRefreshTokenExpiry</span><span class="o">();</span>

            <span class="n">authRefreshToken</span> <span class="o">=</span> <span class="n">tokenProvider</span><span class="o">.</span><span class="na">createAuthToken</span><span class="o">(</span>
                    <span class="n">appProperties</span><span class="o">.</span><span class="na">getAuth</span><span class="o">().</span><span class="na">getTokenSecret</span><span class="o">(),</span>
                    <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">now</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">refreshTokenExpiry</span><span class="o">)</span>
            <span class="o">);</span>

            <span class="c1">// DB에 refresh 토큰 업데이트</span>
            <span class="n">userRefreshToken</span><span class="o">.</span><span class="na">setRefreshToken</span><span class="o">(</span><span class="n">authRefreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>

            <span class="kt">int</span> <span class="n">cookieMaxAge</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">refreshTokenExpiry</span> <span class="o">/</span> <span class="mi">60</span><span class="o">;</span>
            <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">deleteCookie</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="no">REFRESH_TOKEN</span><span class="o">);</span>
            <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="no">REFRESH_TOKEN</span><span class="o">,</span> <span class="n">authRefreshToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">(),</span> <span class="n">cookieMaxAge</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nc">ApiResponse</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">"token"</span><span class="o">,</span> <span class="n">newAccessToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="userservice">UserService</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="usercontroller">UserController</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/v1/users"</span><span class="o">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="nc">ApiResponse</span> <span class="nf">getUser</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">userdetails</span><span class="o">.</span><span class="na">User</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">userdetails</span><span class="o">.</span><span class="na">User</span><span class="o">)</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="n">principal</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>

        <span class="k">return</span> <span class="nc">ApiResponse</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="apiresponseheader">ApiResponseHeader</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Setter</span>
<span class="nd">@Getter</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiResponseHeader</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="apiresponse">ApiResponse</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">SUCCESS</span> <span class="o">=</span> <span class="mi">200</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">NOT_FOUND</span> <span class="o">=</span> <span class="mi">400</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">FAILED</span> <span class="o">=</span> <span class="mi">500</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">SUCCESS_MESSAGE</span> <span class="o">=</span> <span class="s">"SUCCESS"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">NOT_FOUND_MESSAGE</span> <span class="o">=</span> <span class="s">"NOT FOUND"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">FAILED_MESSAGE</span> <span class="o">=</span> <span class="s">"서버에서 오류가 발생하였습니다."</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">INVALID_ACCESS_TOKEN</span> <span class="o">=</span> <span class="s">"Invalid access token."</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">INVALID_REFRESH_TOKEN</span> <span class="o">=</span> <span class="s">"Invalid refresh token."</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">NOT_EXPIRED_TOKEN_YET</span> <span class="o">=</span> <span class="s">"Not expired token yet."</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ApiResponseHeader</span> <span class="n">header</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">body</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ApiResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">success</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="no">T</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApiResponseHeader</span><span class="o">(</span><span class="no">SUCCESS</span><span class="o">,</span> <span class="no">SUCCESS_MESSAGE</span><span class="o">),</span> <span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ApiResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">fail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApiResponseHeader</span><span class="o">(</span><span class="no">FAILED</span><span class="o">,</span> <span class="no">FAILED_MESSAGE</span><span class="o">),</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ApiResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">invalidAccessToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApiResponseHeader</span><span class="o">(</span><span class="no">FAILED</span><span class="o">,</span> <span class="no">INVALID_ACCESS_TOKEN</span><span class="o">),</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ApiResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">invalidRefreshToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApiResponseHeader</span><span class="o">(</span><span class="no">FAILED</span><span class="o">,</span> <span class="no">INVALID_REFRESH_TOKEN</span><span class="o">),</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ApiResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">notExpiredTokenYet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApiResponseHeader</span><span class="o">(</span><span class="no">FAILED</span><span class="o">,</span> <span class="no">NOT_EXPIRED_TOKEN_YET</span><span class="o">),</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="headerutil">HeaderUtil</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HeaderUtil</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HEADER_AUTHORIZATION</span> <span class="o">=</span> <span class="s">"Authorization"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">TOKEN_PREFIX</span> <span class="o">=</span> <span class="s">"Bearer "</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getAccessToken</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">headerValue</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="no">HEADER_AUTHORIZATION</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">headerValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">headerValue</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">TOKEN_PREFIX</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">headerValue</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="no">TOKEN_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="cookieutil">CookieUtil</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CookieUtil</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Cookie</span><span class="o">&gt;</span> <span class="nf">getCookie</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cookies</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addCookie</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxAge</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="n">cookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="n">maxAge</span><span class="o">);</span>

        <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">deleteCookie</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cookies</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">cookie</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
                    <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">serialize</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getUrlEncoder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="nc">SerializationUtils</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">obj</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">deserialize</span><span class="o">(</span><span class="nc">Cookie</span> <span class="n">cookie</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">cls</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span>
                <span class="nc">SerializationUtils</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span>
                        <span class="nc">Base64</span><span class="o">.</span><span class="na">getUrlDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span>
                <span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h2 id="맺음">맺음</h2>

<p>포스팅을 나누지 않고 한 번에 작성하다보니 엄청나게 긴 포스팅이 되었습니다. 나눠서 하는 것보다는 이 포스팅 하나만 보면 OAuth 로그인을 구현할 수 있으면 좋겠다는 생각에 이렇게 작성하게되었습니다.</p>

<p>가능한한 최대한 자세하게 설명하려고 노력했지만 부족한 점이 있을 것 같습니다. 혹시나 읽으시면서 궁금하신 점이나 이상한 점이 있으시면 댓글 부탁드리겠습니다.</p>

<p>감사합니다.</p>
:ET